{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="card shadow-sm">
  <div class="card-body">

    <!-- HEADER -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="text-success mb-0">Sale History</h5>
      <div>
        <button class="btn btn-sm btn-outline-success">Excel</button>
        <button class="btn btn-sm btn-outline-danger">PDF</button>
        <button class="btn btn-sm btn-outline-primary">CSV</button>
      </div>
    </div>

    <!-- SEARCH -->
    <div class="mb-3 text-end">
      <input type="text" class="form-control w-25 d-inline" placeholder="Search">
    </div>

    <!-- TABLE -->
    <div class="table-responsive">
      <table class="table table-bordered table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th>Date</th><th>Bill No</th><th>Sold By</th><th>Customer</th>
            <th>Sale Total</th><th>Discount</th><th>Net Amount</th>
            <th>Payment Mode</th><th>Detail</th><th>Offline Bill</th><th>Delete</th>
          </tr>
        </thead>
        <tbody>
          {% for sale in sales %}
          <tr>
            <td>{{ sale.created_at|date:"Y-m-d H:i" }}</td>
            <td>{{ sale.order_id }}</td>
            <td>{{ request.user.username }}</td>
            <td>{{ sale.customer.name|default:"Walk-in" }}</td>
            <td>PKR {{ sale.total|floatformat:2 }}</td>
            <td>PKR {{ sale.discount|default:"0.00" }}</td>
            <td>PKR {{ sale.total|floatformat:2 }}</td>
            <td>{{ sale.payment_method|title }}</td>
            <td>
              <button type="button" class="btn btn-sm btn-primary"
                      data-bs-toggle="modal" data-bs-target="#receiptModal"
                      onclick="loadReceipt('{{ sale.order_id }}')">
                <i class="bi bi-file-text"></i> Detail
              </button>
            <td>
          {% if perms.ZH_pos.delete_order %}
          <form action="{% url 'delete_order' sale.order_id %}" method="post" style="display:inline;">
            {% csrf_token %}
            <button type="submit" class="btn btn-sm btn-danger"
                    onclick="return confirm('Are you sure you want to delete this sale?');">
              <i class="bi bi-trash"></i> Delete
            </button>
          </form>
          {% endif %}
        </td>


          </tr>
          {% empty %}
          <tr>
            <td colspan="11" class="text-center text-muted">No sales found</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

  </div>
</div>

<!-- RECEIPT MODAL -->
<div class="modal fade" id="receiptModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content p-3">
      <div class="text-center mb-2">
        <img src="{% static 'media/logo-1.jpeg' %}" height="60" alt="Logo">
        <p class="small mb-0">Contact : 0313-6330101</p>
        <hr>
        <strong>Sales Receipt</strong>
      </div>
      <div id="receipt-body" class="small text-start">Loading...</div>
    </div>
  </div>
</div>

<script>
function loadReceipt(orderId) {
  fetch(`/sales/receipt/${orderId}/`)
    .then(res => {
      if (!res.ok) throw new Error('Failed to load receipt');
      return res.json();
    })
    .then(data => {
      let html = `
        <p><strong>Bill No:</strong> ${data.bill}</p>
        <p><strong>Date:</strong> ${data.date}</p>
        <p><strong>Payment:</strong> ${data.payment}</p>
        <p><strong>Customer:</strong> ${data.customer}</p>
        <hr>
        <table class="table table-sm">
          ${data.items.map(i => `
            <tr>
              <td>${i.name} x ${i.qty}</td>
              <td class="text-end">${i.amount}</td>
            </tr>
          `).join("")}
        </table>
        <hr>
        <h6 class="text-center">Total : ${data.total}</h6>
      `;
      document.getElementById("receipt-body").innerHTML = html;
    })
    .catch(err => {
      console.error(err);
      document.getElementById("receipt-body").innerHTML = "Failed to load receipt.";
    });
}
</script>
{% endblock %}
