{% extends "base.html" %}
{% load static %}
{% block content %}

<!-- HEADER ROW WITH TITLE AND EXPORT BUTTONS -->
<div class="d-flex align-items-center justify-content-between mb-3">
  <h4 class="text-success mb-0">E-Commerce Orders</h4>

  <!-- EXPORT BUTTONS -->
  <div id="export-buttons" class="d-flex gap-1"></div>
</div>

<!-- E-COMMERCE ORDERS TABLE -->
<table id="ecommerceTable" class="display table table-bordered w-100">
  <thead>
    <tr>
      <th>Date</th>
      <th>Order Number</th>
      <th>Order By</th>
      <th>Customer</th>
      <th>Sale Total</th>
      <th>Net Amount</th>
      <th>Order Type</th>
      <th>Status</th>
      <th>Detail</th>
    </tr>
  </thead>
  <tbody>
    {% for order in orders %}
    <tr>
      <td>{{ order.created_at|date:"Y-m-d H:i:s" }}</td>
      <td>{{ order.order_id }}</td>
      <td>{{ order.created_by.username|default:"admin" }}</td>
      <td>{{ order.customer.name|default:"Guest" }}</td>
      <td>{{ order.subtotal }}</td>
      <td>PKRs {{ order.total }}</td>
      <td>Online Store</td>
      <td>
        <span class="badge 
          {% if order.status == 'pending' %}bg-info
          {% elif order.status == 'processing' %}bg-warning
          {% elif order.status == 'completed' %}bg-success
          {% elif order.status == 'cancelled' %}bg-danger
          {% else %}bg-secondary{% endif %}">
          {{ order.status|title }}
        </span>
      </td>
      <td>
        <button
          class="btn btn-sm btn-primary"
          onclick="loadReceipt('{{ order.order_id }}')"
          data-bs-toggle="modal"
          data-bs-target="#receiptModal">
          Detail
        </button>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<!-- ================= RECEIPT MODAL ================= -->
<div class="modal fade" id="receiptModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content p-3">
      <div class="text-center mb-2">
        <img src="{% static 'media/logo-1.jpeg' %}" height="60" alt="Logo">
        <p class="small mb-0">Contact : 0313-6330101</p>
        <hr>
        <strong>Sales Receipt</strong>
      </div>
      <div id="receipt-body" class="small text-start">Loading...</div>
    </div>
  </div>
</div>
<!-- ================================================= -->

<!-- ================= DATATABLES & EXPORT BUTTONS ================= -->
<script>
$(document).ready(function () {
  const table = $('#ecommerceTable').DataTable({
    pageLength: 10,
    lengthMenu: [10, 100, 200, 500],
    dom: 'Bfrtip',
    order: [[ 0, "desc"]],
    buttons: [
      { extend: 'excelHtml5', className: 'btn btn-sm btn-outline-success', title: 'Ecommerce_Orders' },
      { extend: 'csvHtml5', className: 'btn btn-sm btn-outline-primary', title: 'Ecommerce_Orders' },
      { 
        extend: 'pdfHtml5',
        className: 'btn btn-sm btn-outline-danger',
        title: 'Ecommerce Orders',
        orientation: 'portrait',
        pageSize: 'A4'
      }
    ]
  });

  // Move DataTables buttons into the custom export-buttons div
  table.buttons().container().appendTo('#export-buttons');
});
</script>

<!-- ================= RECEIPT FETCH ================= -->
<script>
function loadReceipt(orderId) {
  fetch(`/sales/receipt/${orderId}/`)
    .then(res => {
      if (!res.ok) throw new Error('Failed to load receipt');
      return res.json();
    })
    .then(data => {
      let html = `
        <p><strong>Bill No:</strong> ${data.bill}</p>
        <p><strong>Date:</strong> ${data.date}</p>
        <p><strong>Payment:</strong> ${data.payment}</p>
        <p><strong>Customer:</strong> ${data.customer}</p>
        <hr>
        <table class="table table-sm">
          ${data.items.map(i => `
            <tr>
              <td>${i.name} x ${i.qty}</td>
              <td class="text-end">${i.amount}</td>
            </tr>
          `).join("")}
        </table>
        <hr>
        <h6 class="text-center">Total : ${data.total}</h6>
      `;
      document.getElementById("receipt-body").innerHTML = html;
    })
    .catch(() => {
      document.getElementById("receipt-body").innerHTML = "Failed to load receipt.";
    });
}
</script>

{% endblock %}
