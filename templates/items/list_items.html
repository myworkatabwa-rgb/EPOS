{% extends "base.html" %}
{% load static %}

{% block content %}

<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css">

<div class="container-fluid">

  <!-- PAGE HEADER -->
  <div class="card mb-3">
    <div class="card-body d-flex justify-content-between align-items-center flex-wrap gap-2">
      <h5 class="mb-0">Items</h5>

      <div class="d-flex gap-2">
        <button id="bulkDeleteBtn" class="btn btn-danger btn-sm">
          Delete Selected
        </button>

        <a href="#" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#importModal">
          Import Page
        </a>
      </div>
    </div>
  </div>

  <!-- TABLE CARD -->
  <div class="card">
    <div class="card-body">

      <form id="bulkDeleteForm" method="post" action="{% url 'delete_items' %}">
        {% csrf_token %}

        <div class="table-responsive">
          <table id="itemTable" class="table table-bordered table-hover table-sm align-middle">
            <thead class="table-light">
              <tr>
                <th>
                  <input type="checkbox" id="selectAll">
                </th>
                <th>ID</th>
                <th>Barcode</th>
                <th>Name</th>
                <th>Unit</th>
                <th>Category</th>
                <th>Sub Category</th>
                <th>Purchase Rate</th>
                <th>Sale Rate</th>
                <th>Status</th>
                <th>Edit</th>
                <th>Delete</th>
              </tr>
            </thead>

          <tbody>

  {% for item in items %}
 
<tr>

  <!-- SELECT -->
  <td class="text-center">
    <input
      type="checkbox"
      class="rowCheckbox"
      name="ids"
      value="{{ item.id }}"
    >
  </td>

  <!-- ID -->
  <td>{{ item.id }}</td>

  <!-- BARCODE -->
  <td>{{ item.sku }}</td>

  <!-- NAME -->
  <td>{{ item.name }}</td>

  <!-- UNIT (not in model yet) -->
  <td>{{ item.unit|default:"-"}}</td>

  <!-- CATEGORY -->
  <td>{{ item.category|default:"-" }}</td>

  <!-- SUB CATEGORY -->
  <td>-</td>

  <!-- PURCHASE RATE -->
  <td>{{ item.regular_price|default:"0.00" }}</td>

  <!-- SALE RATE -->
  <td>{{ item.sale_price|default:item.price|default:"0.00" }}</td>

  <!-- STATUS -->
  <td>
    {% if item.published %}
      <span class="badge bg-success">Active</span>
    {% else %}
      <span class="badge bg-danger">Inactive</span>
    {% endif %}
  </td>

  <!-- EDIT -->
  <td>
    <a href="#" class="btn btn-warning btn-sm">
      Edit
    </a>
  </td>

  <!-- DELETE -->
  <td>
    <button
      type="button"
      class="btn btn-danger btn-sm single-delete"
      data-id="{{ item.id }}"
    >
      Delete
    </button>
  </td>

</tr>

{% endfor %}
</tbody>


          </table>
        </div>
      </form>

    </div>
  </div>

</div>

<!-- IMPORT MODAL -->
<div class="modal fade" id="importModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Import Items</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <form method="post" action="{% url 'import_items' %}" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="modal-body">
          <label class="form-label">Select File (CSV / Excel)</label>
          <input type="file" name="file" class="form-control" accept=".csv,.xlsx" required>
        </div>

        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Import</button>
        </div>
      </form>

    </div>
  </div>
</div>

<!-- JS -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

<!-- Buttons deps -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.colVis.min.js"></script>

<script>
$(document).ready(function () {

    const table = $('#itemTable').DataTable({
        pageLength: 10,
        lengthMenu: [[10, 50, 100, 500], [10, 50, 100, 500]],
        dom: 'lBfrtip',
        buttons: ['excel', 'pdf', 'csv', 'colvis'],
        order: [[1, 'asc']]
    });

    // =========================
    // SELECT ALL CHECKBOX
    // =========================
    $('#selectAll').on('change', function () {
        $('.rowCheckbox').prop('checked', this.checked);
    });

    // =========================
    // BULK DELETE
    // =========================
    $('#bulkDeleteBtn').on('click', function (e) {
        e.preventDefault();

        const checked = $('.rowCheckbox:checked').length;

        if (checked === 0) {
            alert('⚠️ Please select at least one item to delete.');
            return;
        }

        if (confirm(`❌ Delete ${checked} selected item(s)? This cannot be undone.`)) {
            $('#bulkDeleteForm').submit();
        }
    });

    // =========================
    // SINGLE DELETE
    // =========================
    $('.single-delete').on('click', function (e) {
        e.preventDefault();

        const id = $(this).data('id');

        if (!confirm('❌ Delete this item? This action cannot be undone.')) {
            return;
        }

        // Remove previous hidden inputs to avoid duplicates
        $('#bulkDeleteForm input[name="ids"]').remove();

        $('<input>', {
            type: 'hidden',
            name: 'ids',
            value: id
        }).appendTo('#bulkDeleteForm');

        $('#bulkDeleteForm').submit();
    });

    // =========================
    // DELETE SUCCESS MESSAGE
    // =========================
    if (window.location.search.includes('deleted=1')) {
        alert('✅ Item(s) deleted successfully');
    }

});
</script>

{% endblock %}
