{% extends "base.html" %}
{% load static %}
{% block content %}

<div class="container-fluid">

    <h4 class="mb-3">Price List</h4>

    <div class="card shadow-sm">
        <div class="card-body">

            <div class="row mb-3">
                <div class="col-md-4">
                    <label>Name</label>
                    <input type="text" id="plist_name" class="form-control">
                </div>
            </div>

            <table class="table table-bordered align-middle" id="priceTable">
                <thead class="table-light">
                    <tr>
                        <th style="width:160px">Barcode</th>
                        <th>Item Name</th>
                        <th style="width:150px">Unit</th>
                        <th style="width:120px">Price</th>
                        <th style="width:150px">Tax</th>
                        <th style="width:160px">Price (Tax Inclusive)</th>
                        <th style="width:80px">Remove</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>

            <div class="mt-3">
                <button class="btn btn-primary" id="addRowBtn">Add More</button>
                <button class="btn btn-success" id="saveBtn">Save</button>
            </div>

        </div>
    </div>
</div>

<!-- PRODUCT PICKER MODAL -->
<div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Select Products</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">

                <input type="text" id="productSearch" class="form-control mb-3" placeholder="Search name or barcode">

                <div class="table-responsive" style="max-height:450px;">
                    <table class="table table-bordered table-sm">
                        <thead class="table-light">
                            <tr>
                                <th>Select</th>
                                <th>ID</th>
                                <th>Barcode</th>
                                <th>Name</th>
                                <th>Unit</th>
                                <th>Rate</th>
                            </tr>
                        </thead>
                        <tbody id="productResults"></tbody>
                    </table>
                </div>

                <div class="text-end mt-3">
                    <button class="btn btn-success" id="addSelectedBtn">
                        Add Selected Items
                    </button>
                </div>

            </div>

        </div>
    </div>
</div>

<script>

// ================= CSRF =================
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        document.cookie.split(';').forEach(cookie => {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            }
        });
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');


// ================= ADD ROW =================
function addRow(focus=true) {

    const row = document.createElement("tr");

    row.innerHTML = `
        <td>
            <input type="text" class="form-control barcode" readonly>
            <input type="hidden" class="item_id">
        </td>
        <td>
            <input type="text" class="form-control item_name bg-light" readonly>
        </td>
        <td>
            <select class="form-control unit">
                {% for u in units %}
                    <option value="{{u.id}}">{{u.name}}</option>
                {% endfor %}
            </select>
        </td>
        <td>
            <input type="number" class="form-control price" step="0.01">
        </td>
        <td>
            <select class="form-control tax">
                {% for t in taxes %}
                    <option value="{{t.id}}" data-rate="{{t.percent}}">{{t.name}}</option>
                {% endfor %}
            </select>
        </td>
        <td>
            <input type="number" class="form-control price_inclusive" step="0.01">
        </td>
        <td class="text-center">
            <button class="btn btn-danger btn-sm removeRow">X</button>
        </td>
    `;

    document.querySelector("#priceTable tbody").appendChild(row);
}

document.getElementById("addRowBtn").addEventListener("click", ()=> {
    loadProducts("");
    new bootstrap.Modal(document.getElementById("productModal")).show();
});


// ================= TAX CALC =================
function getTaxPercent(row){
    const opt = row.querySelector(".tax option:checked");
    return parseFloat(opt.dataset.rate || 0);
}

document.addEventListener("input", function(e){

    const row = e.target.closest("tr");
    if(!row) return;

    const tax = getTaxPercent(row);
    const price = row.querySelector(".price");
    const inclusive = row.querySelector(".price_inclusive");

    if(e.target.classList.contains("price")){
        let p = parseFloat(price.value || 0);
        inclusive.value = (p + (p * tax / 100)).toFixed(2);
    }

    if(e.target.classList.contains("price_inclusive")){
        let inc = parseFloat(inclusive.value || 0);
        price.value = (inc / (1 + tax/100)).toFixed(2);
    }
});


// ================= LOAD PRODUCTS =================
function loadProducts(query){
    fetch("{% url 'search_products' %}?q=" + query)
    .then(res=>res.json())
    .then(response=>{
        const tbody = document.getElementById("productResults");
        tbody.innerHTML="";

        response.data.forEach(p=>{
            tbody.innerHTML += `
                <tr>
                    <td>
                        <input type="checkbox" class="selectItem"
                            data-id="${p.id}"
                            data-name="${p.name}"
                            data-barcode="${p.barcode}"
                            data-rate="${p.rate}">
                    </td>
                    <td>${p.id}</td>
                    <td>${p.barcode}</td>
                    <td>${p.name}</td>
                    <td>${p.unit}</td>
                    <td>${p.rate}</td>
                </tr>
            `;
        });
    });
}

document.getElementById("productSearch").addEventListener("input", function(){
    loadProducts(this.value);
});


// ================= ADD SELECTED PRODUCTS =================
document.getElementById("addSelectedBtn").addEventListener("click", function(){

    const selected = document.querySelectorAll(".selectItem:checked");

    if(selected.length === 0){
        alert("Please select at least one product");
        return;
    }

    selected.forEach(cb=>{

        // Prevent duplicate
        const exists = Array.from(document.querySelectorAll(".item_id"))
            .some(input => input.value === cb.dataset.id);

        if(exists) return;

        addRow(false);

        const row = document.querySelector("#priceTable tbody tr:last-child");

        row.querySelector(".barcode").value = cb.dataset.barcode;
        row.querySelector(".item_name").value = cb.dataset.name;
        row.querySelector(".item_id").value = cb.dataset.id;
        row.querySelector(".price").value = cb.dataset.rate;

        row.querySelector(".price").dispatchEvent(new Event("input"));
    });

    bootstrap.Modal.getInstance(document.getElementById("productModal")).hide();
});


// ================= REMOVE ROW =================
document.addEventListener("click", function(e){
    if(e.target.classList.contains("removeRow")){
        e.target.closest("tr").remove();
    }
});


// ================= SAVE PRICE LIST =================
document.getElementById("saveBtn").addEventListener("click", function(){

    const name = document.getElementById("plist_name").value.trim();

    if(!name){
        alert("Please enter price list name");
        return;
    }

    const rows = document.querySelectorAll("#priceTable tbody tr");
    let items = [];

    rows.forEach(row => {

        const item_id = row.querySelector(".item_id").value;
        if(!item_id) return;

        items.push({
            item_id: item_id,
            unit: row.querySelector(".unit").value,
            price: row.querySelector(".price").value || 0,
            tax: row.querySelector(".tax").value,
            price_inclusive: row.querySelector(".price_inclusive").value || 0
        });
    });

    if(items.length === 0){
        alert("Add at least one item");
        return;
    }

    fetch("{% url 'save_price_list' %}", {
        method: "POST",
        headers:{
            "Content-Type":"application/json",
            "X-CSRFToken": csrftoken
        },
        body: JSON.stringify({
            name: name,
            items: items
        })
    })
    .then(res => res.json())
    .then(data => {

        if(data.success){
            alert("Price List Saved Successfully");
            location.reload();
        }else{
            alert("Error saving price list");
        }

    })
    .catch(err=>{
        console.error(err);
        alert("Server error");
    });

});

</script>

{% endblock %}
