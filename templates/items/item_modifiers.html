{% extends "base.html" %}
{% load static %}

{% block content %}

<div class="container-fluid mt-3">

    <!-- Page Title -->
    <div class="mb-3">
        <h4 class="fw-bold">Add Modifier Group</h4>
        <hr>
    </div>

    <!-- MAIN CARD -->
    <div class="card shadow-sm" style="border-radius:8px;">
        <div class="card-body">

            <!-- Modifier Name -->
            <div class="mb-3">
                <label class="form-label fw-semibold">Modifier</label>
                <input type="text" class="form-control" placeholder="Modifier">
            </div>

            <!-- OPTIONS -->
            <div class="row mb-3">
                <div class="col-md-2">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="isCount">
                        <label class="form-check-label">Is Count</label>
                    </div>
                </div>

                <div class="col-md-2">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox">
                        <label class="form-check-label">Size</label>
                    </div>
                </div>

                <div class="col-md-2">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox">
                        <label class="form-check-label">Crust</label>
                    </div>
                </div>

                <div class="col-md-2">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox">
                        <label class="form-check-label">Flavor</label>
                    </div>
                </div>
            </div>

            <!-- Count -->
            <div class="mb-3">
                <label class="form-label">Count</label>
                <input type="number" class="form-control" placeholder="Count">
            </div>

            <!-- Search + Add -->
            <div class="row mb-4">
    <div class="col-md-6 position-relative d-flex gap-2">

        <input type="text"
               id="productSearch"
               class="form-control"
               placeholder="Type at least 3 characters to search...">

        <button class="btn btn-primary" id="searchBtn">
            Search
        </button>

        <div id="searchResults"
             class="list-group position-absolute w-100"
             style="z-index:1000; top:100%;"></div>

    </div>
</div>


            <!-- TABLE -->
            <div class="table-responsive mb-4">
                <table class="table table-bordered align-middle">
                    <thead class="table-light">
                        <tr>
                            <th style="width:40%">NAME - BARCODE</th>
                            <th style="width:20%">AMOUNT</th>
                            <th style="width:25%">
                                <input type="checkbox"> Get Rate From Modifier
                            </th>
                            <th style="width:15%">DELETE</th>
                        </tr>
                    </thead>
                   
                        <tbody id="modifierTableBody">

                    </tbody>
                </table>
            </div>

            <!-- Bottom Add Button -->
            <div class="text-start">
                <button type="button" class="btn btn-primary px-5" id="saveModifier">
    Add
</button>

            </div>

        </div>
    </div>

</div>
<script>
const searchInput = document.getElementById("productSearch");
const resultsBox = document.getElementById("searchResults");
const tableBody = document.getElementById("modifierTableBody");


// ðŸ”Ž SEARCH WHEN TYPING
searchInput.addEventListener("keyup", function() {

    let query = this.value;

    if (query.length < 3) {
        resultsBox.innerHTML = "";
        return;
    }

    fetch("{% url 'search_products' %}?q=" + query)
        .then(response => response.json())
        .then(data => {

            resultsBox.innerHTML = "";

            data.forEach(product => {

                let item = document.createElement("a");
                item.classList.add("list-group-item", "list-group-item-action");
                item.innerText = product.name + " (" + product.sku + ")";

                item.addEventListener("click", function() {
                    addProductToTable(product);
                    resultsBox.innerHTML = "";
                    searchInput.value = "";
                });

                resultsBox.appendChild(item);
            });
        });
});


// âž• ADD PRODUCT TO TABLE
function addProductToTable(product) {

    // Prevent duplicate products
    const existingRows = tableBody.querySelectorAll("tr");
    for (let row of existingRows) {
        if (row.dataset.productId == product.id) {
            alert("Product already added!");
            return;
        }
    }

    let row = document.createElement("tr");
    row.dataset.productId = product.id;

    row.innerHTML = `
        <td>${product.name} - ${product.sku}</td>

        <td>
            <input type="number"
                   value="0"
                   class="form-control form-control-sm"
                   style="width:100px;">
        </td>

        <td class="text-center">
            <input type="checkbox" class="form-check-input">
        </td>

        <td class="text-center">
            <button type="button"
                    class="btn btn-danger btn-sm deleteRow">
                Delete
            </button>
        </td>
    `;

    tableBody.appendChild(row);

    // Delete row
    row.querySelector(".deleteRow").addEventListener("click", function() {
        row.remove();
    });
}
document.getElementById("saveModifier").addEventListener("click", function() {

    let modifierName = document.querySelector("input[placeholder='Modifier']").value;
    let isCount = document.getElementById("isCount").checked;
    let countValue = document.querySelector("input[placeholder='Count']").value;

    if (!modifierName) {
        alert("Modifier name required");
        return;
    }

    let rows = document.querySelectorAll("#modifierTableBody tr");
    let items = [];

    rows.forEach(row => {
        items.push({
            product_id: row.dataset.productId,
            amount: row.querySelector("input[type='number']").value,
            get_rate: row.querySelector("input[type='checkbox']").checked
        });
    });

    fetch("{% url 'save_modifier' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify({
            name: modifierName,
            is_count: isCount,
            count: countValue,
            items: items
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            window.location.href = "{% url 'modifier_list' %}";
        }
    });

});

</script>
{% endblock %}

