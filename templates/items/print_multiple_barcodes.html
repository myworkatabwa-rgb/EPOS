{% extends "base.html" %}
{% block content %}

<div class="container-fluid">

  <div class="card">
    <div class="card-body">

      <h4 class="mb-3">Print Multiple Barcodes</h4>

      <!-- LABEL SETTINGS -->
      <div class="row">

        <div class="col-md-4">

          <label>Label type</label>

          <select class="form-control" id="label_type">
            <option value="2x1">Continuous dual (2x1)</option>
            <option value="3x1">Continuous dual (3x1)</option>
            <option value="4x1">Continuous dual (4x1)</option>
          </select>

        </div>

      </div>

      <hr>


      <!-- PRICE -->
      <div class="form-check">
        <input type="checkbox" id="show_price" checked>
        <label>Show price</label>
      </div>

      <div class="row mb-2">

        <div class="col-md-2">
          price font size
          <input type="text" id="price_font_size" class="form-control" value="0.6">
        </div>

        <div class="col-md-2">
          price font weight
          <input type="text" id="price_font_weight" class="form-control" value="400">
        </div>

      </div>


      <!-- NAME -->
      <div class="form-check">
        <input type="checkbox" id="show_name" checked>
        <label>Show name</label>
      </div>

      <div class="row mb-2">

        <div class="col-md-2">
          name font size
          <input type="text" id="name_font_size" class="form-control" value="0.6">
        </div>

        <div class="col-md-2">
          name font weight
          <input type="text" id="name_font_weight" class="form-control" value="400">
        </div>

      </div>


      <!-- BARCODE -->
      <div class="form-check">
        <input type="checkbox" id="show_barcode" checked>
        <label>Show barcode</label>
      </div>

      <div class="row mb-2">

        <div class="col-md-2">
          barcode font size
          <input type="text" id="barcode_font_size" class="form-control" value="30">
        </div>

      </div>


      <!-- COMPANY -->
      <div class="form-check">
        <input type="checkbox" id="show_company" checked>
        <label>Show Company Name</label>
      </div>

      <div class="row mb-2">

        <div class="col-md-2">
          storename font size
          <input type="text" id="store_font_size" class="form-control" value="0.6">
        </div>

        <div class="col-md-2">
          storename font weight
          <input type="text" id="store_font_weight" class="form-control" value="400">
        </div>

      </div>


      <!-- MFG DATE -->
      <div class="form-check">
        <input type="checkbox" id="show_mfg">
        <label>Show MFG Date</label>
      </div>

      <div class="row mb-2">

        <div class="col-md-2">
          manufacturing date
          <input type="date" id="mfg_date" class="form-control">
        </div>

      </div>


      <!-- BEST BEFORE -->
      <div class="form-check">
        <input type="checkbox" id="show_best">
        <label>Show Best Before Date</label>
      </div>

      <div class="row mb-3">

        <div class="col-md-2">
          Best Before
          <input type="date" id="best_date" class="form-control">
        </div>

      </div>


      <hr>


      <!-- BARCODE SCAN -->
      <label>Add by barcode scan</label>

      <input type="text"
             id="barcodeInput"
             class="form-control mb-3"
             placeholder="place cursor here for Barcode Scan"
             autofocus>


      <!-- TABLE -->
      <div class="table-responsive">

        <table class="table table-bordered table-sm">

          <thead>

            <tr>
              <th>BarCode</th>
              <th>Item</th>
              <th>Quantity</th>
              <th>Rem</th>
            </tr>

          </thead>

          <tbody id="barcodeTable">

          </tbody>

        </table>

      </div>


      <button class="btn btn-primary mt-2">
        Add More
      </button>

      <button class="btn btn-success mt-2" onclick="generateBarcodes()">
    Generate Barcodes
</button>



    </div>
  </div>

</div>


<script>

// ===============================
// CSRF TOKEN FUNCTION (Django)
// ===============================
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// ===============================
// BARCODE SCAN INPUT
// ===============================
let input = document.getElementById("barcodeInput");

input.addEventListener("keypress", function(e) {

    if (e.key === "Enter") {
        e.preventDefault();

        let barcode = input.value.trim();

        if (!barcode) return;

        fetch(`/api/barcode-search/?barcode=${encodeURIComponent(barcode)}`)
        .then(res => {
            if (!res.ok) throw new Error("Server error");
            return res.json();
        })
        .then(data => {
            if (data.success) {
                addRow(data);
                input.value = "";
                input.focus();
            } else {
                alert("Product not found");
            }
        })
        .catch(error => {
            console.error("Error:", error);
            alert("Something went wrong while searching product");
        });
    }

});


// ===============================
// ADD ROW FUNCTION
// ===============================
function addRow(product) {

    let tbody = document.querySelector("#barcodeTable tbody");

    // Check if product already exists â†’ increase qty
    let existingRows = tbody.querySelectorAll("tr");

    for (let row of existingRows) {
        if (row.children[0].innerText === product.barcode) {
            let qtyInput = row.children[2].querySelector("input");
            qtyInput.value = parseInt(qtyInput.value) + 1;
            return;
        }
    }

    // Create new row
    let row = document.createElement("tr");

    row.innerHTML = `
        <td>${product.barcode}</td>
        <td>${product.name}</td>
        <td>
            <input type="number" value="1" min="1" class="form-control form-control-sm">
        </td>
        <td>
            <button class="btn btn-danger btn-sm remove-btn">
                X
            </button>
        </td>
    `;

    // Remove row button
    row.querySelector(".remove-btn").addEventListener("click", function() {
        row.remove();
    });

    tbody.appendChild(row);
}


// ===============================
// GENERATE BARCODES
// ===============================
function generateBarcodes() {

    let rows = document.querySelectorAll("#barcodeTable tbody tr");

    if (rows.length === 0) {
        alert("No items added");
        return;
    }

    let items = [];

    rows.forEach(row => {

        let barcode = row.children[0].innerText;
        let qty = parseInt(row.children[2].querySelector("input").value) || 1;

        items.push({
            barcode: barcode,
            qty: qty
        });

    });

    let settings = {
        show_price: document.getElementById("show_price").checked,
        show_name: document.getElementById("show_name").checked,
        show_barcode: document.getElementById("show_barcode").checked,
        show_company: document.getElementById("show_company").checked,
        show_mfg: document.getElementById("show_mfg").checked,
        show_best: document.getElementById("show_best").checked,
        mfg_date: document.getElementById("mfg_date").value,
        best_date: document.getElementById("best_date").value
    };

    fetch("/items/generate-barcodes/", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken")
        },
        body: JSON.stringify({
            items: items,
            settings: settings
        })
    })
    .then(res => {
        if (!res.ok) throw new Error("Server error");
        return res.json();
    })
    .then(data => {

        if (data.success) {
            window.open(data.url, "_blank");
        } else {
            alert("Error generating barcodes");
        }

    })
    .catch(error => {
        console.error("Error:", error);
        alert("Something went wrong while generating barcodes");
    });

}

</script>



{% endblock %}
