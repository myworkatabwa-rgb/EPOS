{% extends "base.html" %}
{% load static %}

{% block content %}

<div class="container-fluid">

    <h4 class="mb-3">Bulk Item Update</h4>

    <!-- Top Section -->
    <div class="card p-3 mb-3">

        <div class="row">

            <div class="col-md-4">
                <label>Select Category</label>
                <select id="category" class="form-control">
                    <option value="">Select Category</option>
                    {% for cat in categories %}
                        <option value="{{ cat.id }}">{{ cat.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-2 align-self-end">
                <button class="btn btn-primary w-100" onclick="loadItems()">Load Items</button>
            </div>

        </div>

    </div>

    <!-- Table Section -->
    <div class="card p-3">

        <div class="table-responsive">
            <table class="table table-bordered table-striped" id="bulkTable">
                <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>Barcode</th>
                        <th>Name</th>
                        <th>Unit</th>
                        <th>Category</th>
                        <th>Sub Category</th>
                        <th>Purchase Rate</th>
                        <th>Sale Rate</th>
                        <th>New Purchase Rate</th>
                        <th>Disc. Amount</th>
                        <th>Curr Sale Rate</th>
                        <th>New Sale Rate</th>
                        <th>Tax</th>
                        <th>Supplier</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="15" class="text-center">No Data</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <button class="btn btn-success mt-3" onclick="saveBulk()">Save</button>

    </div>

</div>
<script>

function loadItems() {

    let category = document.getElementById("category").value;

    fetch(`/bulk-update/load-items/?category=${category}`)
    .then(res => res.json())
    .then(data => {

        let tbody = document.querySelector("#bulkTable tbody");
        tbody.innerHTML = "";

        if (data.items.length === 0) {
            tbody.innerHTML = `<tr><td colspan="15" class="text-center">No Data</td></tr>`;
            return;
        }

        data.items.forEach(item => {

            tbody.innerHTML += `
            <tr>
                <td>${item.id}</td>
                <td>${item.barcode}</td>
                <td>${item.name}</td>
                <td>${item.unit}</td>
                <td>${item.category}</td>
                <td>${item.sub_category}</td>
                <td>${item.purchase_rate}</td>
                <td>${item.sale_rate}</td>
                <td><input type="number" class="form-control new_purchase" value=""></td>
                <td><input type="number" class="form-control discount" value=""></td>
                <td>${item.sale_rate}</td>
                <td><input type="number" class="form-control new_sale" value=""></td>
                <td>${item.tax}</td>
                <td>${item.supplier}</td>
                <td>${item.status}</td>
            </tr>`;
        });

    });
}


function saveBulk() {

    let rows = document.querySelectorAll("#bulkTable tbody tr");
    let items = [];

    rows.forEach(row => {

        let id = row.cells[0].innerText;
        let new_purchase = row.querySelector(".new_purchase")?.value;
        let new_sale = row.querySelector(".new_sale")?.value;

        if (new_purchase || new_sale) {
            items.push({
                id: id,
                new_purchase_rate: new_purchase,
                new_sale_rate: new_sale
            });
        }
    });

    fetch("/bulk-update/save/", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify({items: items})
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert("Bulk Update Successful");
            loadItems();
        }
    });

}

</script>
